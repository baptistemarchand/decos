<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DÃ©cos</title>
    <link
      href="https://unpkg.com/maplibre-gl@^5.4.0/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <style>
      body, html {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      #map {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script
      src="https://unpkg.com/maplibre-gl@^5.4.0/dist/maplibre-gl.js"
    ></script>
    <script>
      const map = new maplibregl.Map({
        container: "map",
        style: {
          "version": 8,
          "sources": {
            "opentopomap": {
              "type": "raster",
              "tiles": [
                "https://a.tile.opentopomap.org/{z}/{x}/{y}.png",
                "https://b.tile.opentopomap.org/{z}/{x}/{y}.png",
                "https://c.tile.opentopomap.org/{z}/{x}/{y}.png",
              ],
              "tileSize": 256,
              "attribution":
                "Map data: &copy; <a href='https://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors, <a href='http://viewfinderpanoramas.org'>SRTM</a> | Map style: &copy; <a href='https://opentopomap.org'>OpenTopoMap</a> (<a href='https://creativecommons.org/licenses/by-sa/3.0/'>CC-BY-SA</a>)",
            },
          },
          "layers": [{
            "id": "opentopomap",
            "type": "raster",
            "source": "opentopomap",
            "minzoom": 0,
            "maxzoom": 17,
          }],
        },
        center: [2.3522, 48.8566], // [lng, lat] - Paris!
        zoom: 11,
        maxZoom: 17,
      });

      map.on("load", async () => {
        navigator.geolocation.getCurrentPosition(async (position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          map.setCenter([lon, lat]);

          const km = new URLSearchParams(
            window.location.search,
          ).get("km");

          const url =
            `https://api.vol-rando.com/?lon=${lon}&lat=${lat}&km=${
              km ?? 30
            }`;

          const collection = await (await fetch(url)).json();
          new maplibregl.Marker({ color: "green" })
            .setLngLat([lon, lat])
            .addTo(map);

          map.addSource("my-points", {
            type: "geojson",
            data: collection,
          });

          // Add a circle layer to render the points
          map.addLayer({
            id: "points-layer",
            type: "circle",
            source: "my-points",
            paint: {
              "circle-radius": 7,
              "circle-stroke-width": 1,
              "circle-stroke-color": "black",
              "circle-color": [
                "interpolate",
                ["linear"],
                ["get", "flights"],
                0,
                "pink",
                100,
                "red",
              ],
            },
          });

          // Optional: add tooltip/popups
          map.on("click", "points-layer", (e) => {
            const { name, url, flights } = e.features[0].properties;
            new maplibregl.Popup()
              .setLngLat(e.lngLat)
              .setHTML(
                url
                  ? `<div><a target="_blank" href="${url}"><strong>${name}</strong></a><div>${
                    flights ?? 0
                  } vols</div></div>`
                  : `<div><strong>${name}</strong><div>${
                    flights ?? 0
                  } vols</div></div>`,
              )
              .addTo(map);
          });

          // Cursor styling
          map.on("mouseenter", "points-layer", () => {
            map.getCanvas().style.cursor = "pointer";
          });
          map.on("mouseleave", "points-layer", () => {
            map.getCanvas().style.cursor = "";
          });
        }, () => {
          alert("Could not get current position");
        });
      });

      // Optional: add zoom controls
      map.addControl(new maplibregl.NavigationControl());
    </script>
  </body>
</html>
